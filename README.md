# STGCN: æ—¶ç©ºå›¾å·ç§¯ç½‘ç»œ PyTorch å®ç°

æœ¬é¡¹ç›®æ˜¯è®ºæ–‡ **"Spatio-Temporal Graph Convolutional Networks: A Deep Learning Framework for Traffic Forecasting"** (Yu, Yin, and Zhu) çš„ä¸€ä¸ªæ¸…æ™°ã€æ¨¡å—åŒ–çš„PyTorchå®ç°ã€‚

è¯¥æ¡†æ¶æ—¨åœ¨å¤„ç†æ—¶ç©ºå›¾æ•°æ®ï¼Œå°¤å…¶é€‚ç”¨äºäº¤é€šæµé‡é¢„æµ‹ã€‚æœ¬é¡¹ç›®ä»é›¶å¼€å§‹æ­å»ºï¼ŒåŒ…å«äº†æ•°æ®å¤„ç†ã€æ¨¡å‹æ„å»ºã€è®­ç»ƒã€éªŒè¯å’Œæ£€æŸ¥ç‚¹ç®¡ç†ç­‰å®Œæ•´æµç¨‹ï¼Œå¹¶æ”¯æŒå¤šç§æ•°æ®æ¨¡å¼ï¼Œæ–¹ä¾¿æµ‹è¯•å’ŒéªŒè¯ã€‚

## ğŸš€ ä¸»è¦åŠŸèƒ½

- **æ¨¡å—åŒ–è®¾è®¡**: ä»£ç ç»“æ„æ¸…æ™°ï¼Œåˆ†ä¸ºæ•°æ®å¤„ç†ã€æ¨¡å‹å®šä¹‰ã€è®­ç»ƒé€»è¾‘ç­‰æ¨¡å—ï¼Œæ˜“äºç†è§£å’Œæ‰©å±•ã€‚
- **çµæ´»çš„é…ç½®**: æ‰€æœ‰è¶…å‚æ•°å’Œè·¯å¾„å‡ç”± `config.yaml` æ–‡ä»¶ç»Ÿä¸€ç®¡ç†ï¼Œæ— éœ€ä¿®æ”¹ä»£ç å³å¯è°ƒæ•´å®éªŒè®¾ç½®ã€‚
- **å¤šç§æ•°æ®æ¨¡å¼**:
    1.  **æ¨¡æ‹Ÿæ•°æ®æ¨¡å¼**: åŠ¨æ€ç”Ÿæˆçº¯éšæœºæ•°æ®ï¼Œç”¨äºå¿«é€ŸéªŒè¯ä»£ç é€»è¾‘å’Œæ¨¡å‹èƒ½å¦è·‘é€šã€‚
    2.  **åŠçœŸå®æ•°æ®é›†æ¨¡å¼**: ç”Ÿæˆå…·æœ‰æ—¶ç©ºç‰¹æ€§çš„æ¨¡æ‹Ÿæ•°æ®ï¼Œç”¨äºåˆæ­¥çš„æ¨¡å‹æ•ˆæœè¯„ä¼°ã€‚
    3.  **çœŸå®æ•°æ®é›†æ¨¡å¼ (METR-LA)**: æ”¯æŒæ ‡å‡†çš„METR-LAäº¤é€šæ•°æ®é›†ï¼Œæä¾›ä»ä¸‹è½½ã€é¢„å¤„ç†åˆ°è®­ç»ƒçš„å®Œæ•´å·¥ä½œæµã€‚
- **æ–­ç‚¹ç»­ä¼ **: è‡ªåŠ¨ä¿å­˜å’ŒåŠ è½½æ¨¡å‹æ£€æŸ¥ç‚¹ï¼Œå¯ä»¥ä»ä¸Šæ¬¡ä¸­æ–­çš„åœ°æ–¹ç»§ç»­è®­ç»ƒã€‚
- **å¼ºåˆ¶é‡è®­ç»ƒ**: æ”¯æŒ `--retrain` å‘½ä»¤è¡Œå‚æ•°ï¼Œå¯ä»¥å¿½ç•¥æ£€æŸ¥ç‚¹ï¼Œä»å¤´å¼€å§‹è®­ç»ƒã€‚

## ğŸ“‚ é¡¹ç›®ç»“æ„

```
stgcn_project/
â”œâ”€â”€ checkpoints/              # å­˜æ”¾æ¨¡å‹æ£€æŸ¥ç‚¹æ–‡ä»¶
â”œâ”€â”€ config.yaml               # é›†ä¸­ç®¡ç†æ‰€æœ‰è¶…å‚æ•°å’Œé…ç½®
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ raw/                  # å­˜æ”¾ä¸‹è½½çš„åŸå§‹æ•°æ®
â”‚   â””â”€â”€ processed/            # å­˜æ”¾é¢„å¤„ç†åçš„æ•°æ®
â”œâ”€â”€ stgcn_lib/                # æ ¸å¿ƒåº“ï¼Œå­˜æ”¾æ‰€æœ‰æ¨¡å‹å’Œå·¥å…·ä»£ç 
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ dataset.py
â”‚   â”œâ”€â”€ model.py
â”‚   â”œâ”€â”€ trainer.py
â”‚   â””â”€â”€ utils.py
â”œâ”€â”€ scripts/                  # å­˜æ”¾ä¸€æ¬¡æ€§æ•°æ®å¤„ç†è„šæœ¬
â”‚   â”œâ”€â”€ download_data.py
â”‚   â””â”€â”€ preprocess_metr_la.py
â”œâ”€â”€ generate_dataset.py       # ç”¨äºç”ŸæˆåŠçœŸå®æ•°æ®é›†
â”œâ”€â”€ run.py                    # é¡¹ç›®çš„ä¸»å…¥å£ï¼Œç”¨äºå¯åŠ¨è®­ç»ƒ
â””â”€â”€ README.md                 # é¡¹ç›®è¯´æ˜æ–‡ä»¶
â””â”€â”€ requirements.txt          # é¡¹ç›®ä¾èµ–çš„PythonåŒ…
```

## ğŸ”§ ç¯å¢ƒå®‰è£…

1.  **å…‹éš†é¡¹ç›®**
    ```bash
    git clone https://github.com/17wuyou/stgcn_project.git
    cd stgcn_project
    ```

2.  **åˆ›å»ºå¹¶æ¿€æ´»Pythonè™šæ‹Ÿç¯å¢ƒ** (æ¨è)
    ```bash
    # For Unix/macOS
    python3 -m venv venv
    source venv/bin/activate
    
    # For Windows
    python -m venv venv
    venv\Scripts\activate
    ```

3.  **å®‰è£…ä¾èµ–**
    ```bash
    pip install -r requirements.txt
    ```

## âš™ï¸ è¿è¡ŒæŒ‡å— (Usage)

æœ¬é¡¹ç›®é€šè¿‡ä¿®æ”¹ `config.yaml` æ–‡ä»¶ä¸­çš„ `data_mode` å‚æ•°æ¥åˆ‡æ¢ä¸åŒçš„æ•°æ®æºã€‚

---

### æ¨¡å¼ä¸€ï¼šä½¿ç”¨åŠ¨æ€æ¨¡æ‹Ÿæ•°æ® (Dummy Data Mode)

**å·¥ä½œåŸç†**: æ­¤æ¨¡å¼ç”¨äºå¿«é€Ÿæµ‹è¯•ã€‚å®ƒä¼šåœ¨å†…å­˜ä¸­åŠ¨æ€ç”Ÿæˆçº¯éšæœºçš„å¼ é‡ä½œä¸ºè¾“å…¥æ•°æ®ï¼Œä¸æ¶‰åŠä»»ä½•æ–‡ä»¶è¯»å†™ã€‚éå¸¸é€‚åˆç”¨äºéªŒè¯ä»£ç æµç¨‹æ˜¯å¦é€šé¡ºã€‚

**æ“ä½œæ­¥éª¤**:

1.  **é…ç½® `config.yaml`**:
    å°† `data_mode` è®¾ç½®ä¸º `'dummy'`ã€‚
    ```yaml
    data:
      data_mode: 'dummy'
      # ... å…¶ä»–å‚æ•°åœ¨æ­¤æ¨¡å¼ä¸‹ä¼šè¢«å¿½ç•¥
    ```

2.  **è¿è¡Œä¸»ç¨‹åº**:
    ```bash
    python run.py
    ```
    ç¨‹åºå°†æ‰“å° "Data mode: dummy" å¹¶å¼€å§‹ä½¿ç”¨éšæœºæ•°æ®è¿›è¡Œè®­ç»ƒã€‚

---

### æ¨¡å¼äºŒï¼šä½¿ç”¨åŠçœŸå®æ•°æ®é›† (Semi-realistic Mode)

**å·¥ä½œåŸç†**: æ­¤æ¨¡å¼é¦–å…ˆä¼šè¿è¡Œä¸€ä¸ªè„šæœ¬æ¥ç”Ÿæˆä¸€ä¸ªå…·æœ‰æ—¶åºç‰¹æ€§ï¼ˆå¸¦å™ªå£°çš„æ­£å¼¦æ³¢ï¼‰å’Œç©ºé—´ç»“æ„çš„ `.npz` æ•°æ®æ–‡ä»¶ï¼Œç„¶åæ¨¡å‹ä¼šåŠ è½½è¿™ä¸ªæ–‡ä»¶è¿›è¡Œè®­ç»ƒã€‚

**æ“ä½œæ­¥éª¤**:

1.  **é…ç½® `config.yaml`**:
    å°† `data_mode` è®¾ç½®ä¸º `'semi_realistic'`ã€‚
    ```yaml
    data:
      data_mode: 'semi_realistic'
      semi_realistic_path: "./data/semi_realistic_dataset.npz"
      # ...
    ```

2.  **ç”Ÿæˆæ•°æ®é›† (åªéœ€è¿è¡Œä¸€æ¬¡)**:
    è¿è¡Œ `generate_dataset.py` è„šæœ¬æ¥åˆ›å»ºæ•°æ®æ–‡ä»¶ã€‚
    ```bash
    python generate_dataset.py
    ```
    æ‰§è¡Œåï¼Œä¼šåœ¨ `./data/` ç›®å½•ä¸‹ç”Ÿæˆ `semi_realistic_dataset.npz` æ–‡ä»¶ã€‚

3.  **è¿è¡Œä¸»ç¨‹åº**:
    ```bash
    python run.py
    ```
    ç¨‹åºå°†æ‰“å° "Data mode: semi_realistic"ï¼Œå¹¶åŠ è½½åˆšåˆšç”Ÿæˆçš„æ•°æ®æ–‡ä»¶å¼€å§‹è®­ç»ƒã€‚

---

### æ¨¡å¼ä¸‰ï¼šä½¿ç”¨çœŸå®æ•°æ®é›† (METR-LA)

**å·¥ä½œåŸç†**: è¿™æ˜¯æœ€å®Œæ•´çš„æ¨¡å¼ï¼Œæ¨¡æ‹Ÿäº†çœŸå®ä¸–ç•Œçš„ç ”ç©¶æµç¨‹ã€‚å®ƒåˆ†ä¸‰æ­¥ï¼šä¸‹è½½åŸå§‹æ•°æ® -> é¢„å¤„ç†æ•°æ® -> åŠ è½½å¤„ç†å¥½çš„æ•°æ®è¿›è¡Œè®­ç»ƒã€‚

**æ“ä½œæ­¥éª¤**:

1.  **é…ç½® `config.yaml`**:
    å°† `data_mode` è®¾ç½®ä¸º `'metr_la'`ã€‚
    ```yaml
    data:
      data_mode: 'metr_la'
      metr_la:
        raw_path: "./data/raw/metr-la.h5"
        adj_path: "./data/raw/adj_mx.pkl"
        processed_path: "./data/processed/metr_la.npz"
      # ...
    ```

2.  **ä¸‹è½½åŸå§‹æ•°æ® (åªéœ€è¿è¡Œä¸€æ¬¡)**:
    è¿è¡Œ `scripts/download_data.py` è„šæœ¬ã€‚
    ```bash
    python scripts/download_data.py
    ```
    è„šæœ¬ä¼šè‡ªåŠ¨ä¸‹è½½ `metr-la.h5` å’Œ `adj_mx.pkl` æ–‡ä»¶åˆ° `./data/raw/` ç›®å½•ä¸‹ã€‚

3.  **é¢„å¤„ç†æ•°æ® (åªéœ€è¿è¡Œä¸€æ¬¡)**:
    è¿è¡Œ `scripts/preprocess_metr_la.py` è„šæœ¬ã€‚
    ```bash
    python scripts/preprocess_metr_la.py
    ```
    è¯¥è„šæœ¬ä¼šè¯»å–åŸå§‹æ•°æ®ï¼Œè¿›è¡ŒZ-Scoreæ ‡å‡†åŒ–ã€æ»‘åŠ¨çª—å£åˆ‡åˆ†ï¼Œå¹¶å°†æœ€ç»ˆçš„è®­ç»ƒ/éªŒè¯/æµ‹è¯•é›†ä¿å­˜åˆ° `./data/processed/metr_la.npz` æ–‡ä»¶ä¸­ã€‚

4.  **è¿è¡Œä¸»ç¨‹åº**:
    ```bash
    python run.py
    ```
    ç¨‹åºå°†æ‰“å° "Data mode: metr_la"ï¼ŒåŠ è½½å¤„ç†å¥½çš„çœŸå®æ•°æ®é›†å¼€å§‹è®­ç»ƒå’ŒéªŒè¯ã€‚

## ğŸ§  å…¶ä»–åŠŸèƒ½

### æ–­ç‚¹ç»­ä¼ ä¸å¼ºåˆ¶é‡è®­ç»ƒ

- **è‡ªåŠ¨ç»­è®­**: é»˜è®¤æƒ…å†µä¸‹ (`load_checkpoint: true`)ï¼Œæ¯æ¬¡è¿è¡Œ `run.py` éƒ½ä¼šè‡ªåŠ¨åœ¨ `checkpoints` ç›®å½•ä¸‹å¯»æ‰¾æœ€æ–°çš„æ¨¡å‹æ–‡ä»¶å¹¶åŠ è½½ï¼Œä»ä¸Šæ¬¡çš„è¿›åº¦ç»§ç»­è®­ç»ƒã€‚
- **å¼ºåˆ¶é‡è®­**: å¦‚æœä½ æƒ³å¿½ç•¥æ‰€æœ‰æ£€æŸ¥ç‚¹ï¼Œä»é›¶å¼€å§‹ä¸€æ¬¡å…¨æ–°çš„è®­ç»ƒï¼Œè¯·ä½¿ç”¨ `--retrain` å‚æ•°ï¼š
  ```bash
  python run.py --retrain
  ```

## è‡´è°¢

æœ¬é¡¹ç›®çš„è®¾è®¡å’Œæ€æƒ³æºäºåŸä½œè€…çš„æ°å‡ºå·¥ä½œã€‚
- **è®ºæ–‡**: Yu, B., Yin, H., & Zhu, Z. (2018). Spatio-Temporal Graph Convolutional Networks: A Deep Learning Framework for Traffic Forecasting. *IJCAI*.